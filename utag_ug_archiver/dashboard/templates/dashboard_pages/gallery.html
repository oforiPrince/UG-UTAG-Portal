{% extends "base/dashboard_base.html" %}
{% load static %}
{% load image_tags %}
{% block title %}
  Gallery Management
{% endblock title %}
{% block content %}
  <div class="page-content">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="page-title-box">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h6 class="page-title">Gallery Management</h6>
            <ol class="breadcrumb m-0">
              <li class="breadcrumb-item">
                <a href="{% url 'dashboard:dashboard' %}">Dashboard</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">Gallery</li>
            </ol>
          </div>
        </div>
      </div>
      <!-- end page title -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="row align-items-center mb-4">
                <div class="col-md-8">
                  <h4 class="card-title">Image Galleries â€” Overview</h4>
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#addGalleryModal">
                    <i class="mdi mdi-plus-circle me-1"></i> New Gallery
                  </button>
                </div>
              </div>
              <div id="galleryList">
                {% if galleries %}
                  {% for gallery in galleries %}
                    <div class="card mb-3">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-2">
                            {% with cover_image=gallery.get_cover_image %}
                              {% if cover_image %}
                                {% lazy_img cover_image.image.url gallery.title "img-fluid rounded shadow-sm" "gallery" %}
                              {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="width: 100%; height: 150px;">
                                  <i class="fa fa-image fa-2x text-muted"></i>
                                </div>
                              {% endif %}
                            {% endwith %}
                          </div>
                          <div class="col-md-8">
                            <h5>{{ gallery.title }}</h5>
                            <p>{{ gallery.description|default:"No description provided."|truncatewords:20 }}</p>
                            <div class="d-flex gap-3 text-muted small">
                              <span><i class="fa fa-calendar"></i> {{ gallery.created_at|date:"d M Y" }}</span>
                              <span><i class="fa fa-images"></i> {{ gallery.get_image_count }} image{{ gallery.get_image_count|pluralize }}</span>
                              {% if not gallery.is_active %}
                                <span class="badge bg-warning">Inactive</span>
                              {% endif %}
                            </div>
                          </div>
                          <div class="col-md-2 text-end d-flex flex-column gap-2">
                            <button class="btn btn-info btn-sm w-100"
                                    data-bs-toggle="modal"
                                    data-bs-target="#galleryModal_{{ gallery.id }}">
                              <i class="mdi mdi-eye"></i> View
                            </button>
                            <button class="btn btn-secondary btn-sm w-100"
                                    data-bs-toggle="modal"
                                    data-bs-target="#uploadImagesModal"
                                    data-gallery-id="{{ gallery.id }}"
                                    data-gallery-title="{{ gallery.title }}">
                              <i class="mdi mdi-upload"></i> Upload Images
                            </button>
                            <button class="btn btn-info btn-sm w-100"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editGalleryModal"
                                    data-gallery-id="{{ gallery.id }}">
                              <i class="mdi mdi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm w-100 delete-gallery"
                                    data-gallery-id="{{ gallery.id }}">
                              <i class="mdi mdi-delete"></i> Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="alert alert-warning text-center" role="alert">No galleries are available. Please add a new gallery.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Include Modals -->
    {% include "includes/modals/partials/gallery_modals.html" %}
  </div>
{% endblock content %}
{% block my_styles %}
  <link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css"
        rel="stylesheet">
  <style>
    /* Custom Dropzone Styling */
    .dropzone-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      transition: all 0.3s ease;
    }
    .dropzone-container:hover,
    .dropzone-container.dz-drag-hover {
      border-color: #0d6efd !important;
      background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%);
    }
    .dropzone-container .dz-message {
      margin: 2em 0;
    }
    .dropzone-container .dz-preview {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 8px;
      transition: transform 0.2s;
    }
    .dropzone-container .dz-preview:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .dropzone-container .dz-preview .dz-progress {
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    .dropzone-container .dz-preview .dz-success-mark,
    .dropzone-container .dz-preview .dz-error-mark {
      display: none;
      font-size: 1.5rem;
      margin-top: 4px;
    }
    .dropzone-container .dz-preview.dz-success .dz-success-mark { display: block; }
    .dropzone-container .dz-preview.dz-error .dz-error-mark { display: block; }
    .dropzone-container .dz-preview.dz-success .dz-progress,
    .dropzone-container .dz-preview.dz-error .dz-progress { display: none; }
    .dropzone-container .dz-preview .dz-remove {
      color: #dc3545;
      text-decoration: none;
      margin-top: 4px;
    }
    .dropzone-container .dz-preview .dz-remove:hover {
      text-decoration: underline;
    }
    /* Hide default message when files are added */
    .dropzone-container.dz-started .dz-message {
      display: none;
    }
  </style>
{% endblock my_styles %}
{% block my_scripts %}
  <!-- Dropzone JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
  <script>
  // CSRF Token setup for AJAX
  const csrfToken = '{{ csrf_token }}';

  // Add Gallery using AJAX
  $('#addGalleryForm').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    $.ajax({
      url: "{% url 'dashboard:gallery_add' %}",
      type: "POST",
      headers: { "X-CSRFToken": csrfToken },
      data: formData,
      success: function(response) {
        alert(response.message);
        location.reload();
      },
      error: function(xhr) {
        alert('Failed to add gallery: ' + xhr.responseJSON.errors);
      }
    });
  });

  // Professional Gallery Upload with Dropzone
  Dropzone.autoDiscover = false;

  const uploadModal = $('#uploadImagesModal');
  let galleryDropzone = null;
  let uploadStats = { total: 0, completed: 0, success: 0, failed: 0 };

  function initializeDropzone() {
    if (galleryDropzone) {
      galleryDropzone.destroy();
    }

    galleryDropzone = new Dropzone("#galleryDropzone", {
      url: "{% url 'dashboard:gallery_upload_images' %}",
      maxFilesize: 10,
      acceptedFiles: 'image/jpeg,image/jpg,image/png,image/gif,image/webp',
      addRemoveLinks: true,
      dictRemoveFile: 'Remove file',
      dictCancelUpload: 'Cancel upload',
      headers: { "X-CSRFToken": csrfToken },
      paramName: "image",
      parallelUploads: 3,
      autoProcessQueue: true,
      createImageThumbnails: true,
      maxThumbnailFilesize: 10,
      thumbnailWidth: 150,
      thumbnailHeight: 150,
      clickable: true,
      previewsContainer: "#galleryDropzone",
      previewTemplate: `
        <div class="dz-preview dz-file-preview d-inline-block m-2" style="width: 150px;">
          <div class="dz-image rounded overflow-hidden" style="width: 150px; height: 150px;">
            <img data-dz-thumbnail class="w-100 h-100" style="object-fit: cover;" />
          </div>
          <div class="dz-progress mt-1" style="height: 6px;">
            <span class="dz-upload bg-primary" data-dz-uploadprogress style="display: block; height: 100%;"></span>
          </div>
          <div class="dz-success-mark text-success text-center"><i class="mdi mdi-check-circle"></i></div>
          <div class="dz-error-mark text-danger text-center"><i class="mdi mdi-close-circle"></i></div>
          <div class="dz-error-message small text-danger text-center text-truncate" data-dz-errormessage></div>
          <a href="javascript:void(0);" class="dz-remove small text-center d-block" data-dz-remove>Remove</a>
        </div>
      `,
      init: function() {
        const dz = this;

        dz.on("addedfile", function(file) {
          uploadStats.total++;
          updateUploadUI();
        });

        dz.on("sending", function(file, xhr, formData) {
          const galleryId = $('#gallery_id').val();
          if (!galleryId) {
            console.error('No gallery ID found');
            dz.removeFile(file);
            return;
          }
          formData.append("gallery_id", galleryId);
          $('#uploadProgress').removeClass('d-none');
        });

        dz.on("uploadprogress", function(file, progress) {
          updateOverallProgress();
        });

        dz.on("success", function(file, response) {
          uploadStats.completed++;
          uploadStats.success++;
          console.log('Uploaded:', file.name, response);
          updateUploadUI();
          
          // Update thumbnail with server-generated one
          if (response.thumbnail_url) {
            const img = file.previewElement.querySelector('img');
            if (img) img.src = response.thumbnail_url;
          }
        });

        dz.on("error", function(file, error, xhr) {
          uploadStats.completed++;
          uploadStats.failed++;
          console.error('Upload failed:', file.name, error);
          
          let errorMsg = 'Upload failed';
          if (typeof error === 'string') {
            errorMsg = error;
          } else if (error && error.errors) {
            errorMsg = Object.values(error.errors).flat().join(', ');
          } else if (error && error.message) {
            errorMsg = error.message;
          }
          
          const errorEl = file.previewElement.querySelector('.dz-error-message');
          if (errorEl) errorEl.textContent = errorMsg;
          updateUploadUI();
        });

        dz.on("queuecomplete", function() {
          console.log('Queue complete. Success:', uploadStats.success, 'Failed:', uploadStats.failed);
          
          const progressBar = $('#uploadProgress .progress-bar');
          if (uploadStats.failed === 0 && uploadStats.success > 0) {
            progressBar.removeClass('progress-bar-animated bg-primary').addClass('bg-success');
            showResult('success', `Successfully uploaded ${uploadStats.success} image(s)!`);
            setTimeout(function() {
              location.reload();
            }, 1500);
          } else if (uploadStats.success > 0) {
            progressBar.removeClass('progress-bar-animated bg-primary').addClass('bg-warning');
            showResult('warning', `Uploaded ${uploadStats.success} image(s), ${uploadStats.failed} failed.`);
            setTimeout(function() {
              location.reload();
            }, 2500);
          } else if (uploadStats.failed > 0) {
            progressBar.removeClass('progress-bar-animated bg-primary').addClass('bg-danger');
            showResult('danger', `All ${uploadStats.failed} upload(s) failed. Please try again.`);
          }
        });

        dz.on("removedfile", function(file) {
          if (file.status !== Dropzone.SUCCESS) {
            uploadStats.total = Math.max(0, uploadStats.total - 1);
            updateUploadUI();
          }
        });
      }
    });
  }

  function updateOverallProgress() {
    if (!galleryDropzone) return;
    const files = galleryDropzone.files;
    if (files.length === 0) return;
    
    let totalProgress = 0;
    files.forEach(file => {
      totalProgress += (file.upload ? file.upload.progress : 0) || 0;
    });
    const overallProgress = totalProgress / files.length;
    
    const progressBar = $('#uploadProgress .progress-bar');
    progressBar.css('width', overallProgress + '%').attr('aria-valuenow', Math.round(overallProgress));
  }

  function updateUploadUI() {
    $('#uploadCount').text(`${uploadStats.completed} / ${uploadStats.total}`);
    if (uploadStats.total > 0) {
      $('#uploadProgress').removeClass('d-none');
    }
  }

  function showResult(type, message) {
    $('#uploadResults').html(`<div class="alert alert-${type} py-2 mb-0">${message}</div>`);
  }

  function resetUploadState() {
    uploadStats = { total: 0, completed: 0, success: 0, failed: 0 };
    if (galleryDropzone) {
      galleryDropzone.removeAllFiles(true);
    }
    $('#uploadProgress').addClass('d-none');
    $('#uploadProgress .progress-bar')
      .css('width', '0%')
      .attr('aria-valuenow', 0)
      .removeClass('bg-success bg-warning bg-danger')
      .addClass('bg-primary progress-bar-animated');
    $('#uploadCount').text('0 / 0');
    $('#uploadResults').empty();
  }

  // Initialize dropzone when modal opens
  uploadModal.on('show.bs.modal', function(e) {
    const button = $(e.relatedTarget);
    const galleryId = button.data('gallery-id');
    const galleryTitle = button.data('gallery-title');
    
    if (!galleryId) {
      console.error('No gallery ID provided');
      e.preventDefault();
      return;
    }
    
    $('#gallery_id').val(galleryId);
    $(this).find('.modal-title').text('Upload Images to ' + galleryTitle);
  });

  uploadModal.on('shown.bs.modal', function() {
    resetUploadState();
    initializeDropzone();
  });

  uploadModal.on('hidden.bs.modal', function() {
    resetUploadState();
    if (galleryDropzone) {
      galleryDropzone.destroy();
      galleryDropzone = null;
    }
  });
  

  // Delete Gallery
  $(document).on('click', '.delete-gallery', function(e) {
    e.preventDefault();
    const galleryId = $(this).data('gallery-id');
    const galleryTitle = $(this).closest('.card').find('h5').text();
    if (confirm(`Are you sure you want to delete the gallery "${galleryTitle}"? This will also delete all images in this gallery.`)) {
      $.ajax({
        url: `/dashboard/galleries/delete/${galleryId}/`,
        type: "DELETE",
        headers: { "X-CSRFToken": csrfToken },
        success: function(response) {
          alert(response.message);
          location.reload();  // Reload the page to show the updated gallery list
        },
        error: function(xhr) {
          const errorMsg = xhr.responseJSON?.error || xhr.responseJSON?.message || 'Failed to delete gallery';
          alert('Error: ' + errorMsg);
        }
      });
    }
  });

  // Open the Edit Gallery Modal
  $('#editGalleryModal').on('show.bs.modal', function(e) {
    const button = $(e.relatedTarget);
    const galleryId = button.data('gallery-id');

    // Fetch gallery details via AJAX
    $.ajax({
      url: `/dashboard/galleries/edit/${galleryId}/`,
      type: "GET",
      success: function(response) {
        $('#editGalleryId').val(response.gallery.id);
        $('#editGalleryTitle').val(response.gallery.title);
        $('#editGalleryDescription').val(response.gallery.description);

        // Load images into the modal
        const imagesContainer = $('#galleryImages');
        imagesContainer.empty();
        if (response.gallery.images && response.gallery.images.length > 0) {
          response.gallery.images.forEach(image => {
            const thumbnailUrl = image.thumbnail || image.image;
            imagesContainer.append(`
              <div class="col-md-4 col-sm-6 mb-3">
                <div class="card shadow-sm">
                  <img src="${thumbnailUrl}" 
                       class="card-img-top img-fluid rounded-top" 
                       alt="${image.caption || 'Image'}"
                       style="height: 200px; object-fit: cover;"
                       loading="lazy">
                  <div class="card-body p-2">
                    <p class="card-text small mb-1">${image.caption || 'No Caption'}</p>
                    <button class="btn btn-danger btn-sm w-100 delete-image" 
                            data-image-id="${image.id}"
                            title="Delete this image">
                      <i class="mdi mdi-delete"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            `);
          });
        } else {
          imagesContainer.append(`
            <div class="col-12">
              <div class="text-center py-4">
                <i class="fa fa-image fa-3x text-muted mb-3"></i>
                <p class="text-muted">No images in this gallery.</p>
              </div>
            </div>
          `);
        }
      },
      error: function(xhr) {
        alert('Failed to fetch gallery details.');
      }
    });
  });

// Handle Save Changes
$('#editGalleryForm').on('submit', function(e) {
  e.preventDefault();
  const galleryId = $('#editGalleryId').val();
  const formData = $(this).serialize();

  $.ajax({
    url: `/dashboard/galleries/edit/${galleryId}/`,
    type: "POST",
    headers: { "X-CSRFToken": csrfToken },
    data: formData,
    success: function(response) {
      //alert(response.message);
      location.reload();  // Reload the page to reflect changes
    },
    error: function(xhr) {
      alert('Failed to update gallery.');
    }
  });
});

// Handle Image Deletion
$(document).on('click', '.delete-image', function() {
  const imageId = $(this).data('image-id');
  if (confirm('Are you sure you want to delete this image?')) {
    $.ajax({
      url: `/dashboard/images/delete/${imageId}/`,
      type: "DELETE",
      headers: { "X-CSRFToken": csrfToken },
      success: function(response) {
        //alert(response.message);
        location.reload();  // Reload the page to reflect changes
      },
      error: function(xhr) {
        alert('Failed to delete image.');
      }
    });
  }
});

  </script>
{% endblock my_scripts %}
