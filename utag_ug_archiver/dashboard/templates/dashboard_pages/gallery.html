{% extends "base/dashboard_base.html" %}
{% load static %}
{% block title %}
  Gallery Management
{% endblock title %}
{% block content %}
  <div class="page-content">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="page-title-box">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h6 class="page-title">Gallery Management</h6>
            <ol class="breadcrumb m-0">
              <li class="breadcrumb-item">
                <a href="{% url 'dashboard:dashboard' %}">Dashboard</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">Gallery</li>
            </ol>
          </div>
        </div>
      </div>
      <!-- end page title -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="row align-items-center mb-4">
                <div class="col-md-8">
                  <h4 class="card-title">Image Galleries â€” Overview</h4>
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#addGalleryModal">
                    <i class="mdi mdi-plus-circle me-1"></i> New Gallery
                  </button>
                </div>
              </div>
              <div id="galleryList">
                {% if galleries %}
                  {% for gallery in galleries %}
                    <div class="card mb-3">
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-2">
                            {% with cover_image=gallery.get_cover_image %}
                              {% if cover_image %}
                                <img src="{{ cover_image.get_thumbnail_url }}"
                                     class="img-fluid rounded shadow-sm"
                                     alt="Gallery Cover"
                                     style="width: 100%; height: 150px; object-fit: cover;"
                                     loading="lazy">
                              {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="width: 100%; height: 150px;">
                                  <i class="fa fa-image fa-2x text-muted"></i>
                                </div>
                              {% endif %}
                            {% endwith %}
                          </div>
                          <div class="col-md-8">
                            <h5>{{ gallery.title }}</h5>
                            <p>{{ gallery.description|default:"No description provided."|truncatewords:20 }}</p>
                            <div class="d-flex gap-3 text-muted small">
                              <span><i class="fa fa-calendar"></i> {{ gallery.created_at|date:"d M Y" }}</span>
                              <span><i class="fa fa-images"></i> {{ gallery.get_image_count }} image{{ gallery.get_image_count|pluralize }}</span>
                              {% if not gallery.is_active %}
                                <span class="badge bg-warning">Inactive</span>
                              {% endif %}
                            </div>
                          </div>
                          <div class="col-md-2 text-end d-flex flex-column gap-2">
                            <button class="btn btn-info btn-sm w-100"
                                    data-bs-toggle="modal"
                                    data-bs-target="#galleryModal_{{ gallery.id }}">
                              <i class="mdi mdi-eye"></i> View
                            </button>
                            <button class="btn btn-secondary btn-sm w-100"
                                    data-bs-toggle="modal"
                                    data-bs-target="#uploadImagesModal"
                                    data-gallery-id="{{ gallery.id }}"
                                    data-gallery-title="{{ gallery.title }}">
                              <i class="mdi mdi-upload"></i> Upload Images
                            </button>
                            <button class="btn btn-info btn-sm w-100"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editGalleryModal"
                                    data-gallery-id="{{ gallery.id }}">
                              <i class="mdi mdi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm w-100 delete-gallery"
                                    data-gallery-id="{{ gallery.id }}">
                              <i class="mdi mdi-delete"></i> Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="alert alert-warning text-center" role="alert">No galleries are available. Please add a new gallery.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Include Modals -->
    {% include "includes/modals/partials/gallery_modals.html" %}
  </div>
{% endblock content %}
{% block my_styles %}
  <link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css"
        rel="stylesheet">
{% endblock my_styles %}
{% block my_scripts %}
  <!-- Dropzone JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
  <script>
  // CSRF Token setup for AJAX
  const csrfToken = '{{ csrf_token }}';

  // Add Gallery using AJAX
  $('#addGalleryForm').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    $.ajax({
      url: "{% url 'dashboard:gallery_add' %}",
      type: "POST",
      headers: { "X-CSRFToken": csrfToken },
      data: formData,
      success: function(response) {
        alert(response.message);
        location.reload();  // Reload the page to show the updated gallery list
      },
      error: function(xhr) {
        alert('Failed to add gallery: ' + xhr.responseJSON.errors);
      }
    });
  });

  // Upload Images with Dropzone
  Dropzone.autoDiscover = false;

  const uploadModal = $('#uploadImagesModal');
  const dropzone = new Dropzone("#dropzone", {
    url: "{% url 'dashboard:gallery_upload_images' %}",
    maxFilesize: 10, // MB (increased for high-quality images)
    acceptedFiles: 'image/jpeg,image/jpg,image/png,image/gif,image/webp',
    addRemoveLinks: true,
    headers: { "X-CSRFToken": csrfToken },
    paramName: "image",  // Ensure param name matches form field
    parallelUploads: 5,  // Reduced for better server performance
    autoProcessQueue: true,
    maxThumbnailFilesize: 10, // MB
    thumbnailWidth: 200,
    thumbnailHeight: 200,
    resizeWidth: null, // Let server handle optimization
    resizeHeight: null,
    init: function() {
      const dz = this;
  
      // Append gallery_id to FormData
      dz.on("sending", function(file, xhr, formData) {
        const galleryId = uploadModal.find('#gallery_id').val();
        formData.append("gallery_id", galleryId);
        // Show progress bar
        $('#uploadProgress').removeClass('d-none');
      });
      
      // Track upload progress
      dz.on("uploadprogress", function(file, progress, bytesSent) {
        const progressBar = $('#uploadProgress .progress-bar');
        progressBar.css('width', progress + '%').attr('aria-valuenow', progress).text(Math.round(progress) + '%');
      });
  
      // Success event for each file
      dz.on("success", function(file, response) {
        console.log('Successfully uploaded and optimized:', file.name);
        // Show success message
        if (response.message) {
          file.previewElement.classList.add("dz-success");
          // Update file preview with thumbnail if available
          if (response.thumbnail_url) {
            $(file.previewElement).find('img').attr('src', response.thumbnail_url);
          }
        }
      });
  
      // Handle errors
      dz.on("error", function(file, error) {
        console.error('Failed to upload:', file.name, error);
        file.previewElement.classList.add("dz-error");
        let errorMsg = 'Upload failed';
        if (typeof error === 'string') {
          errorMsg = error;
        } else if (error.message) {
          errorMsg = error.message;
        } else if (error.xhr && error.xhr.responseJSON) {
          errorMsg = JSON.stringify(error.xhr.responseJSON.errors || error.xhr.responseJSON);
        }
        $(file.previewElement).find('.dz-error-message').text(errorMsg);
      });
  
      // Event when all files in the queue have been processed
      dz.on("queuecomplete", function() {
        // All files have been uploaded; show success and reload
        console.log("All images uploaded and optimized successfully!");
        const progressBar = $('#uploadProgress .progress-bar');
        progressBar.removeClass('progress-bar-animated').addClass('bg-success').text('Complete!');
        setTimeout(function() {
          location.reload();
        }, 1500); // Small delay to show success state
      });
      
      // Reset dropzone when modal is closed
      uploadModal.on('hidden.bs.modal', function() {
        dz.removeAllFiles(true);
        $('#uploadProgress').addClass('d-none');
        const progressBar = $('#uploadProgress .progress-bar');
        progressBar.css('width', '0%').attr('aria-valuenow', 0).text('0%')
                   .removeClass('bg-success').addClass('progress-bar-animated');
      });
    }
  });



  uploadModal.on('show.bs.modal', function(e) {
    const button = $(e.relatedTarget);
    const galleryId = button.data('gallery-id');
    const galleryTitle = button.data('gallery-title');
    $(this).find('#gallery_id').val(galleryId);
    $(this).find('.modal-title').text('Upload Images to ' + galleryTitle);
  });
  

  // Delete Gallery
  $(document).on('click', '.delete-gallery', function(e) {
    e.preventDefault();
    const galleryId = $(this).data('gallery-id');
    const galleryTitle = $(this).closest('.card').find('h5').text();
    if (confirm(`Are you sure you want to delete the gallery "${galleryTitle}"? This will also delete all images in this gallery.`)) {
      $.ajax({
        url: `/dashboard/galleries/delete/${galleryId}/`,
        type: "DELETE",
        headers: { "X-CSRFToken": csrfToken },
        success: function(response) {
          alert(response.message);
          location.reload();  // Reload the page to show the updated gallery list
        },
        error: function(xhr) {
          const errorMsg = xhr.responseJSON?.error || xhr.responseJSON?.message || 'Failed to delete gallery';
          alert('Error: ' + errorMsg);
        }
      });
    }
  });

  // Open the Edit Gallery Modal
  $('#editGalleryModal').on('show.bs.modal', function(e) {
    const button = $(e.relatedTarget);
    const galleryId = button.data('gallery-id');

    // Fetch gallery details via AJAX
    $.ajax({
      url: `/dashboard/galleries/edit/${galleryId}/`,
      type: "GET",
      success: function(response) {
        $('#editGalleryId').val(response.gallery.id);
        $('#editGalleryTitle').val(response.gallery.title);
        $('#editGalleryDescription').val(response.gallery.description);

        // Load images into the modal
        const imagesContainer = $('#galleryImages');
        imagesContainer.empty();
        if (response.gallery.images && response.gallery.images.length > 0) {
          response.gallery.images.forEach(image => {
            const thumbnailUrl = image.thumbnail || image.image;
            imagesContainer.append(`
              <div class="col-md-4 col-sm-6 mb-3">
                <div class="card shadow-sm">
                  <img src="${thumbnailUrl}" 
                       class="card-img-top img-fluid rounded-top" 
                       alt="${image.caption || 'Image'}"
                       style="height: 200px; object-fit: cover;"
                       loading="lazy">
                  <div class="card-body p-2">
                    <p class="card-text small mb-1">${image.caption || 'No Caption'}</p>
                    <button class="btn btn-danger btn-sm w-100 delete-image" 
                            data-image-id="${image.id}"
                            title="Delete this image">
                      <i class="mdi mdi-delete"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            `);
          });
        } else {
          imagesContainer.append(`
            <div class="col-12">
              <div class="text-center py-4">
                <i class="fa fa-image fa-3x text-muted mb-3"></i>
                <p class="text-muted">No images in this gallery.</p>
              </div>
            </div>
          `);
        }
      },
      error: function(xhr) {
        alert('Failed to fetch gallery details.');
      }
    });
  });

// Handle Save Changes
$('#editGalleryForm').on('submit', function(e) {
  e.preventDefault();
  const galleryId = $('#editGalleryId').val();
  const formData = $(this).serialize();

  $.ajax({
    url: `/dashboard/galleries/edit/${galleryId}/`,
    type: "POST",
    headers: { "X-CSRFToken": csrfToken },
    data: formData,
    success: function(response) {
      //alert(response.message);
      location.reload();  // Reload the page to reflect changes
    },
    error: function(xhr) {
      alert('Failed to update gallery.');
    }
  });
});

// Handle Image Deletion
$(document).on('click', '.delete-image', function() {
  const imageId = $(this).data('image-id');
  if (confirm('Are you sure you want to delete this image?')) {
    $.ajax({
      url: `/dashboard/images/delete/${imageId}/`,
      type: "DELETE",
      headers: { "X-CSRFToken": csrfToken },
      success: function(response) {
        //alert(response.message);
        location.reload();  // Reload the page to reflect changes
      },
      error: function(xhr) {
        alert('Failed to delete image.');
      }
    });
  }
});

  </script>
{% endblock my_scripts %}
