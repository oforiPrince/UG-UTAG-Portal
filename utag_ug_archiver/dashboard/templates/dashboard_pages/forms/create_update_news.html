{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block title %}
{% if news.pk %}
    Update News
{% else %}
    Create News
{% endif %}
{% endblock title %}

{% block content %}
<div class="page-content">
  <div class="container-fluid">
    <!-- Page Title -->
    <div class="page-title-box mb-4">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h6 class="page-title">
            {% if news.pk %}
              Edit News Article
            {% else %}
              Create New News Article
            {% endif %}
          </h6>
          <ol class="breadcrumb m-0">
            <li class="breadcrumb-item">
              <a href="{% url 'dashboard:dashboard' %}">Dashboard</a>
            </li>
            <li class="breadcrumb-item">
              <a href="{% url 'dashboard:news' %}">News</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              {% if news.pk %}Edit{% else %}Create{% endif %}
            </li>
          </ol>
        </div>
        <div class="col-md-4">
          <div class="float-end d-none d-md-block">
            <a href="{% url 'dashboard:news' %}" class="btn btn-secondary btn-sm">
              <i class="mdi mdi-arrow-left"></i> Back to News
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body p-4">

            <!-- News Form -->
            <form id="newsForm" method="POST" enctype="multipart/form-data" class="custom-validation">
              {% csrf_token %}

              <!-- Form Sections -->
              <div class="row">
                <div class="col-12">
                  <!-- Basic Info Section -->
                  <div class="mb-4">
                    <h5 class="card-title mb-3">
                      <i class="mdi mdi-information-outline me-2"></i>Basic Information
                    </h5>
                    
                    <!-- News Title -->
                    <div class="mb-3">
                      <label for="title" class="form-label fw-bold">News Title <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="title" name="title" value="{{ initial_data.title }}" placeholder="Enter a compelling news headline" required>
                      <small class="text-muted">Make it descriptive and engaging</small>
                    </div>

                    <!-- Tags -->
                    <div class="mb-3">
                      <label for="tags" class="form-label fw-bold">Tags</label>
                      <select class="form-control select2" id="tags" name="tags" multiple="multiple">
                        {% for tag in tags %}
                          <option value="{{ tag.id }}" {% if tag.id in initial_data.tags %}selected{% endif %}>{{ tag.name }}</option>
                        {% endfor %}
                      </select>
                      <small class="text-muted">Select or create tags to categorize this article</small>
                    </div>
                  </div>

                  <!-- Featured Image Section -->
                  <div class="mb-4 pb-4 border-bottom">
                    <h5 class="card-title mb-3">
                      <i class="mdi mdi-image-outline me-2"></i>Featured Image
                    </h5>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <label for="image" class="form-label fw-bold">Upload Image</label>
                        <input type="file" class="form-control" id="image" name="featured_image" accept="image/*">
                        <small class="text-muted">Recommended size: 1200x600px</small>
                        <div id="imageError" class="text-danger mt-2"></div>
                      </div>
                      <div class="col-md-6">
                        <!-- Current Image -->
                        {% if initial_data.featured_image %}
                          <div class="text-center">
                            <p class="text-muted mb-2"><strong>Current Image:</strong></p>
                            <img src="{{ initial_data.featured_image }}" 
                                alt="Current Image" 
                                class="img-fluid rounded shadow-sm border" 
                                style="max-width: 100%; max-height: 150px;">
                          </div>
                        {% endif %}

                        <!-- New Image Preview -->
                        <div id="newImagePreviewWrapper" class="text-center" style="display: none;">
                          <p class="text-muted mb-2"><strong>Preview:</strong></p>
                          <img id="newImagePreview" 
                              class="img-fluid rounded shadow-sm border" 
                              style="max-width: 100%; max-height: 150px;" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Content Section -->
                  <div class="mb-4 pb-4 border-bottom">
                    <h5 class="card-title mb-3">
                      <i class="mdi mdi-file-document-outline me-2"></i>Article Content
                    </h5>
                    
                    <div class="mb-3">
                      <label for="content" class="form-label fw-bold">News Content <span class="text-danger">*</span></label>
                      <textarea class="form-control" id="content" name="content" rows="10" placeholder="Write your news article here...">{{ initial_data.content }}</textarea>
                      <small class="text-muted">Rich text editor available below. Add formatting, links, and media as needed.</small>
                    </div>
                  </div>

                  <!-- Citations Section -->
                  <div class="mb-4 pb-4 border-bottom">
                    <h5 class="card-title mb-3">
                      <i class="mdi mdi-book-outline me-2"></i>Citations & References
                    </h5>
                    
                    <div id="citationsWrapper">
                      {% for citation in initial_data.citations %}
                      <div class="citation-item mb-3 p-3 rounded border bg-light">
                        <div class="row">
                          <div class="col-md-6">
                            <input type="text" name="citation_sources[]" class="form-control mb-2" placeholder="Source Name" value="{{ citation.source_name }}">
                          </div>
                          <div class="col-md-6">
                            <input type="url" name="citation_urls[]" class="form-control mb-2" placeholder="Source URL (e.g., https://...)" value="{{ citation.url }}">
                          </div>
                        </div>
                        <textarea name="citation_descriptions[]" class="form-control mb-2" placeholder="Description" rows="2">{{ citation.description }}</textarea>
                        <button type="button" class="btn btn-danger btn-sm remove-citation">
                          <i class="mdi mdi-delete me-1"></i>Remove
                        </button>
                      </div>
                      {% endfor %}
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="addCitation">
                      <i class="mdi mdi-plus me-1"></i>Add Citation
                    </button>
                  </div>

                  <!-- Attached Documents Section -->
                  <div class="mb-4 pb-4 border-bottom">
                    <h5 class="card-title mb-3">
                      <i class="mdi mdi-paperclip me-2"></i>Attached Documents
                    </h5>
                    
                    <div id="documentsWrapper">
                      {% for document in initial_data.attached_documents %}
                      <div class="document-item mb-3 p-3 rounded border bg-light">
                        <div class="row">
                          <div class="col-md-5">
                            <input type="text" name="document_names[]" class="form-control mb-2 mb-md-0" placeholder="Document Name" value="{{ document.name }}">
                          </div>
                          <div class="col-md-5">
                            <input type="file" name="document_files[]" class="form-control">
                          </div>
                          <div class="col-md-2">
                            <a href="{{ document.file.url }}" class="btn btn-info btn-sm w-100" target="_blank">
                              <i class="mdi mdi-eye"></i> View
                            </a>
                          </div>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm mt-2 remove-document">
                          <i class="mdi mdi-delete me-1"></i>Remove
                        </button>
                      </div>
                      {% endfor %}
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="addDocument">
                      <i class="mdi mdi-plus me-1"></i>Add Document
                    </button>
                  </div>

                  <!-- Publication Settings -->
                  <div class="mb-4 p-3 rounded bg-light border">
                    <h5 class="card-title mb-3">
                      <i class="mdi mdi-cog-outline me-2"></i>Publication Settings
                    </h5>
                    
                    <div class="row g-2 align-items-center">
                      <div class="col-md-6">
                        <label for="createdAt" class="form-label fw-bold">Created at</label>
                        <input type="datetime-local" id="createdAt" name="created_at" class="form-control" value="{% if initial_data.created_at_iso %}{{ initial_data.created_at_iso }}{% endif %}">
                        <small class="text-muted d-block">Set the published date/time for this article.</small>
                      </div>
                      <div class="col-md-6">
                        <div class="form-check form-switch mt-4">
                          <input type="checkbox" class="form-check-input" id="isPublished" name="is_published" {% if news.is_published or initial_data.is_published %}checked{% endif %}>
                          <label class="form-check-label fw-bold" for="isPublished">
                            Publish Now
                            <small class="text-muted d-block mt-1">(Make this news visible to the public immediately)</small>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Form Actions -->
                  <div class="d-flex justify-content-between align-items-center pt-3">
                    <a href="{% url 'dashboard:news' %}" class="btn btn-light d-md-none">
                      <i class="mdi mdi-arrow-left me-1"></i>Back
                    </a>
                    <div class="gap-2 d-flex ms-auto">
                      <a href="{% url 'dashboard:news' %}" class="btn btn-secondary d-none d-md-inline-block">
                        <i class="mdi mdi-close me-1"></i>Cancel
                      </a>
                      <button type="submit" class="btn btn-primary">
                        <i class="mdi mdi-check-circle-outline me-2"></i>
                        {% if news.pk %}Update Article{% else %}Publish Article{% endif %}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
            <!-- End News Form -->

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block my_styles %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<style>
  .citation-item, .document-item {
    transition: all 0.3s ease;
  }

  .form-label {
    color: #333;
    margin-bottom: 0.5rem;
  }

  .card-title {
    color: #002147;
    font-weight: 600;
  }

  .text-danger {
    color: #dc3545;
  }

  .btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
  }

  .btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
  }

  #citationsWrapper, #documentsWrapper {
    max-height: 600px;
    overflow-y: auto;
  }
</style>
{% endblock my_styles %}

{% block my_scripts %}
<script>
  // Dynamic New Image Preview
    document.getElementById('image').addEventListener('change', function (event) {
      const file = event.target.files[0];
      const previewWrapper = document.getElementById('newImagePreviewWrapper');
      const previewImage = document.getElementById('newImagePreview');
      const imageError = document.getElementById('imageError');

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewWrapper.style.display = 'block'; // Show new image preview
          imageError.textContent = ''; // Clear any previous errors
        };
        reader.readAsDataURL(file);
      } else {
        previewWrapper.style.display = 'none'; // Hide new image preview if no file is selected
        previewImage.src = '';
      }
    });


  // Initialize Select2 for Tags
  $(document).ready(function () {
    $('#tags').select2({
      tags: true,
      tokenSeparators: [','],
      placeholder: 'Add or select tags',
      allowClear: true
    });

    // Add and remove citations dynamically
    $('#addCitation').click(function () {
      $('#citationsWrapper').append(`
        <div class="citation-item mb-3 p-3 rounded border bg-light">
          <div class="row">
            <div class="col-md-6">
              <input type="text" name="citation_sources[]" class="form-control mb-2" placeholder="Source Name">
            </div>
            <div class="col-md-6">
              <input type="url" name="citation_urls[]" class="form-control mb-2" placeholder="Source URL (e.g., https://...)">
            </div>
          </div>
          <textarea name="citation_descriptions[]" class="form-control mb-2" placeholder="Description" rows="2"></textarea>
          <button type="button" class="btn btn-danger btn-sm remove-citation">
            <i class="mdi mdi-delete me-1"></i>Remove
          </button>
        </div>
      `);
    });

    $('#citationsWrapper').on('click', '.remove-citation', function () {
      $(this).closest('.citation-item').remove();
    });

    // Add and remove documents dynamically
    $('#addDocument').click(function () {
      $('#documentsWrapper').append(`
        <div class="document-item mb-3 p-3 rounded border bg-light">
          <div class="row">
            <div class="col-md-5">
              <input type="text" name="document_names[]" class="form-control mb-2 mb-md-0" placeholder="Document Name">
            </div>
            <div class="col-md-5">
              <input type="file" name="document_files[]" class="form-control">
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-danger btn-sm w-100 remove-document">
                <i class="mdi mdi-delete"></i>
              </button>
            </div>
          </div>
        </div>
      `);
    });

    $('#documentsWrapper').on('click', '.remove-document', function () {
      $(this).closest('.document-item').remove();
    });

    // Initialize TinyMCE
    tinymce.init({
      selector: '#content',
      plugins: 'lists link image media table paste code help wordcount',
      toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image media | code help',
      menubar: false,
      branding: false,
      height: 400,
    });
  });
</script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- TinyMCE JS -->
<script src="https://cdn.tiny.cloud/1/o2od9vtnj8aoy1tgpyf7siqsvkg91xau2fyy5dlo0h5sy1an/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}
