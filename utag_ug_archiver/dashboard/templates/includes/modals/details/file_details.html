{% load static %}
{% for document in documents %}
    <!-- Modal for Document Detail -->
    <div class="modal fade"
         id="documentDetailModal_{{ document.id }}"
         tabindex="-1"
         role="dialog"
         aria-labelledby="documentDetailModalTitle_{{ document.id }}"
         aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="documentDetailModalTitle_{{ document.id }}" class="modal-title">Document Details - {{ document.title }}</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body p-5">
                    <div class="row">
                        <div class="col-md-6">
                            <p>
                                <strong>Uploaded By:</strong>
                                {{ document.uploaded_by_name|default:"-" }}
                            </p>
                            <p>
                                <strong>Category:</strong>
                                {{ document.category_label|default:document.get_category_display|default:"N/A" }}
                            </p>
                            <p>
                                <strong>Date:</strong> {{ document.date }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p>
                                <strong>Sender:</strong> {{ document.sender }}
                            </p>
                            <p>
                                <strong>Receiver:</strong> {{ document.receiver }}
                            </p>
                            <p>
                                <strong>Status:</strong>
                                {{ document.status_label|default:document.get_status_display|default:"N/A" }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h5>Title</h5>
                            <div class="card">
                                <div class="card-body">
                                    <p>{{ document.title }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Description</h5>
                            <div class="card">
                                <div class="card-body">
                                    <p>{{ document.description |safe }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    {% if document.files.all %}
                        <p class="text-success">Uploaded Document</p>
                        <div class="card">
                            <div class="row mb-3 mt-3">
                                {% for file in document.files.all %}
                                    {% if not file.deleted %}
                                        {# Add this condition to exclude deleted files #}
                                        <div class="col-md-2 mb-3" id="file_{{ file.id }}">
                                            {% comment %} Image previews {% endcomment %}
                                            {% if file.file.name|lower|slice:'-4:' == ".png" or file.file.name|lower|slice:'-4:' == ".jpg" or file.file.name|lower|slice:'-5:' == ".jpeg" or file.file.name|lower|slice:'-4:' == ".gif" %}
                                                <a href="{{ file.file.url }}" target="_blank">
                                                    <img src="{{ file.file.url }}"
                                                         class="img-fluid"
                                                         alt="{{ file.file.name }}"
                                                         width="160"
                                                         height="120">
                                                </a>
                                            {% elif file.file.name|lower|slice:'-4:' == ".pdf" %}
                                                {# PDF - show PDF icon and provide inline preview toggle #}
                                                <a href="{{ file.file.url }}" target="_blank">
                                                    <img src="{% static 'dashboard/assets/images/file/pdf.png' %}"
                                                         alt="PDF Icon"
                                                         class="img-fluid"
                                                         width="120"
                                                         height="120">
                                                </a>
                                            {% elif file.file.name|lower|slice:'-5:' == ".docx" or file.file.name|lower|slice:'-4:' == ".doc" or file.file.name|lower|slice:'-5:' == ".pptx" or file.file.name|lower|slice:'-4:' == ".ppt" or file.file.name|lower|slice:'-5:' == ".xlsx" or file.file.name|lower|slice:'-4:' == ".xls" %}
                                                {# Office documents - show office icon #}
                                                <a href="{{ file.file.url }}" target="_blank">
                                                    <img src="{% static 'dashboard/assets/images/file/office.png' %}"
                                                         alt="Document Icon"
                                                         class="img-fluid"
                                                         width="120"
                                                         height="120">
                                                </a>
                                            {% else %}
                                                <!-- Generic document icon for unknown types -->
                                                <a href="{{ file.file.url }}" target="_blank">
                                                    <img src="{% static 'dashboard/assets/images/file/generic.png' %}"
                                                         alt="Document Icon"
                                                         class="img-fluid"
                                                         width="120"
                                                         height="120">
                                                </a>
                                            {% endif %}

                                            <div class="text-center mt-2">
                                                <a href="#" class="btn btn-danger btn-sm"
                                                   onclick="removeFile('{{ file.id }}')">
                                                    <i class="mdi mdi-delete"></i>
                                                </a>

                                                {# Preview toggle (for PDFs and Office files). Only show inline preview if server-side check succeeded #}
                                                {% if file.file.name|lower|slice:'-4:' == ".pdf" or file.file.name|lower|slice:'-5:' == ".docx" or file.file.name|lower|slice:'-4:' == ".doc" or file.file.name|lower|slice:'-5:' == ".pptx" or file.file.name|lower|slice:'-4:' == ".ppt" or file.file.name|lower|slice:'-5:' == ".xlsx" or file.file.name|lower|slice:'-4:' == ".xls" %}
                                                    {% if file.previewable %}
                                                        <a class="btn btn-sm btn-success" data-bs-toggle="collapse" href="#file_preview_{{ file.id }}" role="button" aria-expanded="false" aria-controls="file_preview_{{ file.id }}">
                                                            <i class="mdi mdi-eye"></i>
                                                        </a>
                                                    {% else %}
                                                        <a class="btn btn-sm btn-success" href="{{ file.file.url }}" target="_blank" title="Preview unavailable (file not publicly accessible)">
                                                            <i class="mdi mdi-eye-off"></i>
                                                        </a>
                                                    {% endif %}
                                                {% else %}
                                                    <a href="{{ file.file.url }}" class="btn btn-sm btn-success" target="_blank">
                                                        <i class="mdi mdi-eye"></i>
                                                    </a>
                                                {% endif %}

                                                <a href="{{ file.file.url }}" class="btn btn-sm btn-primary" download>
                                                    <i class="mdi mdi-download"></i>
                                                </a>
                                            </div>

                                            {# Collapsible preview area - renders below the icon when toggled #}
                                            {% if file.file.name|lower|slice:'-4:' == ".pdf" %}
                                                <div class="collapse mt-2" id="file_preview_{{ file.id }}">
                                                    <div class="card card-body">
                                                        {% if file.previewable %}
                                                            <object data="{{ file.absolute_url }}" type="application/pdf" width="100%" height="600">
                                                                <p>Your browser does not support PDF preview. <a href="{{ file.file.url }}">Download the file</a>.</p>
                                                            </object>
                                                        {% else %}
                                                            <p class="mb-0">Preview unavailable (file not publicly accessible). <a href="{{ file.file.url }}" target="_blank">Download</a></p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% elif file.file.name|lower|slice:'-5:' == ".docx" or file.file.name|lower|slice:'-4:' == ".doc" or file.file.name|lower|slice:'-5:' == ".pptx" or file.file.name|lower|slice:'-4:' == ".ppt" or file.file.name|lower|slice:'-5:' == ".xlsx" or file.file.name|lower|slice:'-4:' == ".xls" %}
                                                <div class="collapse mt-2" id="file_preview_{{ file.id }}">
                                                    <div class="card card-body">
                                                        {# Use Microsoft Office Online viewer as primary; requires the file URL to be publicly reachable over HTTPS. Fall back to Google Docs viewer if Office fails; if not previewable, show download message. #}
                                                        {% if file.previewable %}
                                                            <iframe id="preview_iframe_{{ file.id }}"
                                                                    class="office-preview-iframe"
                                                                    data-collapse-id="file_preview_{{ file.id }}"
                                                                    data-office-src="https://view.officeapps.live.com/op/embed.aspx?src={{ file.absolute_url|urlencode }}"
                                                                    data-google-src="https://docs.google.com/gview?url={{ file.absolute_url|urlencode }}&embedded=true"
                                                                    width="100%" height="600" frameborder="0"></iframe>
                                                        {% else %}
                                                            <p class="mb-0">Preview unavailable (file not publicly accessible). <a href="{{ file.file.url }}" target="_blank">Download</a></p>
                                                        {% endif %}
                                                        <p class="mt-2">If the document doesn't display, <a href="{{ file.file.url }}" target="_blank">download it</a> or ensure the file URL is publicly accessible.</p>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endfor %}

{# JS loader: lazy-load Office preview and fallback to Google Docs after timeout if Office fails. Uses Bootstrap collapse 'shown' event to trigger loading. #}
<script>
document.addEventListener('DOMContentLoaded', function(){
    var iframes = document.querySelectorAll('.office-preview-iframe');
    iframes.forEach(function(iframe){
        var officeSrc = iframe.dataset.officeSrc;
        var googleSrc = iframe.dataset.googleSrc;
        var collapseId = iframe.dataset.collapseId;
        if(!collapseId) return;
        var collapseEl = document.getElementById(collapseId);
        if(!collapseEl) return;
        var loaded = false;
        // When user expands the preview, start loading Office viewer
        collapseEl.addEventListener('shown.bs.collapse', function(){
            if(iframe.dataset.loaded) return; // already attempted
            // mark attempted to avoid repeated work
            iframe.dataset.loaded = 'attempted';
            // attach onload to detect success
            iframe.onload = function(){ iframe.dataset.loaded = '1'; };
            // start with Office online
            iframe.src = officeSrc;
            // fallback to Google viewer if Office doesn't load within timeout (6s)
            setTimeout(function(){
                if(iframe.dataset.loaded !== '1'){
                    iframe.src = googleSrc;
                }
            }, 6000);
        });
    });
});
</script>
